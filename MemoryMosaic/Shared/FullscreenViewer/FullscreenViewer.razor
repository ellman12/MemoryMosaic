@inject IJSRuntime JSRuntime
@inherits ToggleableComponent
@typeparam T where T : Media

<div id="fullscreen-viewer" style="@Visibility.Style">
	<div id="content">
		<IconButton ID="backButton" Icon="arrow_back" OnClick="@Disable"/>
		
		<div id="buttons">
			<IconButton Icon="info" OnClick="@infoVisibility.Toggle"/>
			<IconButton Icon="collections"/>
			<IconButton Icon="@(Current.Starred ? "star" : "star_outline")" OnClick="@UpdateStarred"/>
			<IconButton Icon="edit"/>
			<IconButton Icon="restore"/>
			<IconButton Icon="trash"/>
		</div>

		@if (Index > 0 || (bool) TopLoader?.HasMoreRows)
		{
			<div class="sideButton" @onclick="@MoveLeft"><IconButton Icon="arrow_back_ios"/></div>
		}

		<div id="item">
			@if (Current.Video && Visibility.Visible)
			{
				string path = $"{Current.RequestPath}/{Current.Path}";
				<VideoPlayer Path="@path"/>
			}
			else
			{
				<img src="@Current.RequestPath/@Current.Path" alt=""/>
			}
		</div>

		@if (Index < Content.Count - 1)
		{
			<div class="sideButton" @onclick="@MoveRight"><IconButton Icon="arrow_forward_ios"/></div>
		}
	</div>

	<div id="info" class="@(infoVisibility.Visible ? "visible" : "hidden")">
		<span>Info</span>

		@if (Current is LibraryItem current)
		{
			<div title="Date Taken">
				<MaterialIcon Icon="photo_camera"/>
				<span>@FormatDateTaken(current.DateTaken)</span>
				<IconButton Icon="edit"/>
			</div>

			<div title="Date Added">
				<MaterialIcon Icon="cloud_upload"/>
				<span>@FormatDateTaken(current.DateAdded)</span>
			</div>
		}
		
		<div title="@Path.GetFileName(Current.Path)">
			<MaterialIcon Icon="image"/>
			<span>@Path.GetFileName(Current.Path)</span>
			<IconButton Icon="edit"/>
		</div>

		<textarea autocomplete="off" autocorrect="on" spellcheck="true" placeholder="Add a description">@Current.Description</textarea>
	</div>
</div>

@if (!Current.Video)
{
	<KeyboardShortcuts Left="@MoveLeft" Right="@MoveRight"/>
}

<KeyboardShortcuts AltLeft="@Disable" Esc="@Disable" I="@infoVisibility.Toggle"/>

@code {
	[Parameter, EditorRequired]
	public List<T> Content { get; set; } = null!;

	[Parameter] public ContentLoader? TopLoader { get; set; }
	[Parameter] public ContentLoader? BottomLoader { get; set; }
	
	private T Current => Content[Index];

	private ElementVisibility infoVisibility = new();
	
	private int index;
	public int Index
	{
		get => index;
		set
		{
			if (value < 0 || value > Content.Count) return;
			index = value;
			StateHasChanged();

			JSRuntime.InvokeVoidAsync(Current.Video ? "initializeVideo" : "cleanupVideo");
		}
	}

	protected override void OnInitialized()
	{
		infoVisibility.Rerender = StateHasChanged;
	}
}

@functions {
	private static string FormatDateTaken(DateTime? dateTaken) => dateTaken == null ? "No Date Taken" : dateTaken.Value.ToString("ddd, MMM d, yyyy hh:mm:ss tt");

	private void MoveLeft()
	{
		if (Index == 0 && (bool) TopLoader?.HasMoreRows)
			Index += TopLoader.AddContent(100);
		
		Index--;
	}

	private void MoveRight()
	{
		if (Index == Content.Count - 1 && (bool) BottomLoader?.HasMoreRows)
			BottomLoader.AddContent();

		Index++;
	}

	private void UpdateStarred()
	{
		C.UpdateStarred(Current.Id, !Current.Starred);
		Current.Starred = !Current.Starred;
		StateHasChanged();
	}
}
